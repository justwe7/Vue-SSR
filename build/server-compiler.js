/* SSR编译 */
const MFS = require('memory-fs') // 从内存读取文件
const Webpack = require('webpack')
const { readFile } = require('./utils')
const serverConfig = require('./webpack.server')
const clientConfig = require('./webpack.client')

// watch and update server renderer
const serverCompiler = Webpack(serverConfig)
const mfs = new MFS()
serverCompiler.outputFileSystem = mfs
serverCompiler.watch({}, (err, stats) => {
  if (err) throw err
  stats = stats.toJson()
  // stats为编译过的文件
  if (stats.errors.length) {
    childSend('error', stats.errors)
    return
  }
  // read bundle generated by vue-ssr-webpack-plugin
  bundle = JSON.parse(readFile(
    mfs,
    'vue-ssr-server-bundle.json',
    clientConfig.output.path
  ))
  childSend('bundle', bundle)
})

function childSend (type, data) {
  return process.send({ type, data })
}
